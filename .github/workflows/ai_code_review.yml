name: AI Code Review on PR

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  AI-Review:
    runs-on: ubuntu-latest

    steps:
#      - name: âœ… Checkout PR code
#        uses: actions/checkout@v3

      - name: ğŸ” Debug workspace structure
        run: ls -R .github

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: pip install openai requests

      - name: âœ… Checkout the default branch
        uses: actions/checkout@v4
        with:
          # åœ¨ pull_request_target äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨æ£€å‡º PR æäº¤çš„ä»£ç 
          # å¦åˆ™å®ƒä¼šæ£€å‡ºä¸»åˆ†æ”¯çš„ä»£ç ï¼Œå¯¼è‡´å®¡æŸ¥çš„æ˜¯ä¸»åˆ†æ”¯è€ŒéPRåˆ†æ”¯
          ref: ${{ github.event.pull_request.h  ead.sha }}

      - name: ğŸ§¾ Download PR diff via GitHub API
        id: pr_diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # ç¡®ä¿ GITHUB_TOKEN æœ‰æƒé™è¯»å– PR
          PR_DIFF=$(gh pr view ${{ github.event.number }} --json files --jq '.files | map(.patch) | join("\n")')
          # å°† diff è¾“å‡ºè®¾ç½®ä¸ºä¸€ä¸ªç¯å¢ƒå˜é‡
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$PR_DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ¤– Run AI code review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_ENDPOINT: ${{ secrets.OPENAI_API_ENDPOINT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: python .github/scripts/ai_code_review.py
